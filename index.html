<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <title>Laporan Transaksi</title>

    <!-- QRCode Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1/qrcode.min.js"></script>

    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/3.2.0/sha.js"></script>

    <style>
        :root {
            --border-color: #555;
            --gray-light: #efefef;
            --font-main: Arial, sans-serif;
        }

        body {
            font-family: var(--font-main);
            margin: 40px auto;
            max-width: 900px;
            line-height: 1.5;
            color: #222;
        }

        #btn-print {
            padding: 10px 20px;
            border: none;
            background: #1976d2;
            color: white;
            font-size: 15px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        #btn-print:hover {
            background: #0d47a1;
        }

        .kop {
            text-align: center;
            margin-bottom: 10px;
        }

        .kop h1 {
            margin: 0;
            font-size: 22px;
        }

        .kop .sub {
            font-size: 13px;
            color: #555;
        }

        hr.kop-line {
            border: none;
            border-top: 2px solid #000;
            margin: 10px 0 20px;
        }

        .meta {
            font-size: 13px;
            margin-bottom: 10px;
            text-align: right;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
            font-size: 14px;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 6px 8px;
            vertical-align: top;
        }

        th {
            background: var(--gray-light);
            font-weight: bold;
            text-align: left;
        }

        .table-header-center th {
            text-align: center;
        }

        .status-badge {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }

        .footer-section {
            margin-top: 30px;
        }
        #qrcode {
            margin-top: 10px;
        }
        #nama-penyusun {
            font-weight: bold;
            margin-top: 20px;
        }
        @media print {
            body {
              margin: 15mm;
            }
            #btn-print {
              display: none;
            }
            a {
              color: black;
              text-decoration: none;
            }
        }
    </style>
</head>

<body>

<button id="btn-print" onclick="window.print()">Cetak PDF</button>

<h1>Dokumen Transaksi</h1>
<div class="sub-title">D'PLan</div>
<div id="tgl-cetak" style="font-size:12px;text-align:right;margin-bottom:10px;"></div>

<!-- ======================= -->
<!--      TABLE DETAIL       -->
<!-- ======================= -->
<table>
    <tbody id="detail-table"></tbody>
</table>

<h3>Riwayat Pembayaran</h3>

<table>
    <thead>
        <tr>
            <th style="width: 35%;">Tanggal</th>
            <th style="width: 35%;">Nominal</th>
            <th style="width: 30%;">Status</th>
        </tr>
    </thead>
    <tbody id="riwayat-body"></tbody>
</table>

<div class="footer-section">
    <div style="font-weight:bold;margin-bottom:5px;">Verifikasi Keaslian</div>
    <div id="qrcode"></div>
</div>

<div class="footer-section">
    <div>Dibukukan oleh:</div>
    <div id="nama-penyusun">Tim Penyusun D'PLan</div>
</div>

<script>
// ------------------------------
// UTILITY
// ------------------------------
function parseJSONFromQuery() {
    const url = new URL(window.location.href);
    const raw = url.searchParams.get("data");
    if (!raw) return null;
    try {
        return JSON.parse(decodeURIComponent(raw));
    } catch {
        return null;
    }
}

function setTanggalCetak() {
    const now = new Date();
    const t = now.toLocaleString("id-ID", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
    });
    document.getElementById("tgl-cetak").textContent = "Dicetak pada: " + t;
}

// ------------------------------
// TABLE DETAIL LAPORAN
// ------------------------------
function buildDetailTable(data) {
    const table = document.getElementById("detail-table");
    const rows = [
        ["Nomor Pinjaman", data.nomorPinjaman],
        ["Nama Pemberi Pinjaman", data.pemberiNama],
        ["No. Telp Pemberi", data.pemberiTelp],
        ["Nama Peminjam", data.peminjamNama],
        ["No. Telp Peminjam", data.peminjamTelp],
        ["Tanggal Penetapan", data.tglPenetapan],
        ["Jatuh Tempo", data.tglJatuhTempo],
        ["Pokok Pinjaman", "Rp " + formatRupiah(data.pokok)],
        ["Total Pembayaran", "Rp " + formatRupiah(data.totalBayar)],
        ["Sisa Pokok", "Rp " + formatRupiah(data.sisaPokok)],
        ["Status", data.status]
    ];

    rows.forEach(r => {
        const tr = document.createElement("tr");
        const td1 = document.createElement("td");
        const td2 = document.createElement("td");
        td1.style.fontWeight = "bold";
        td1.textContent = r[0];
        td2.textContent = r[1];
        tr.appendChild(td1);
        tr.appendChild(td2);
        table.appendChild(tr);
    });
}

function formatRupiah(n) {
    return Number(n).toLocaleString("id-ID");
}

// ------------------------------
// TABEL RIWAYAT PEMBAYARAN
// ------------------------------
function buildRiwayatTable(data) {
    const tbody = document.getElementById("riwayat-body");

    if (!data.riwayat || !Array.isArray(data.riwayat)) return;

    data.riwayat.forEach(item => {
        const tr = document.createElement("tr");

        const tdTgl = document.createElement("td");
        const tdNom = document.createElement("td");
        const tdSta = document.createElement("td");

        tdTgl.textContent = item.tanggal;
        tdNom.textContent = "Rp " + formatRupiah(item.nominal);
        tdSta.textContent = item.status;

        tr.appendChild(tdTgl);
        tr.appendChild(tdNom);
        tr.appendChild(tdSta);

        tbody.appendChild(tr);
    });
}

// ------------------------------
// QR CODE GENERATOR
// ------------------------------
function buildQRCode(data) {
    const target = document.getElementById("qrcode");
    target.innerHTML = "";

    const raw = data.string_verifikasi; // dari Glide

    // Hash SHA-256
    const shaObj = new jsSHA("SHA-256", "TEXT");
    shaObj.update(raw);
    const hash = shaObj.getHash("HEX");

    const qrURL =
        "https://dikskoenma-cmyk.github.io/laporan-cetak/verif.html" +
        "?sv=" + encodeURIComponent(raw) +
        "&hash=" + hash;

    new QRCode(target, {
        text: qrURL,
        width: 140,
        height: 140,
        correctLevel: QRCode.CorrectLevel.L
    });
}

// ===============================
// INIT PAGE
// ===============================
(function init() {
    setTanggalCetak();

    const data = parseJSONFromQuery();
    if (!data) {
        alert("Data laporan tidak ditemukan.");
        return;
    }

    buildDetailTable(data);
    buildRiwayatTable(data);

    // Tunda sedikit agar layout stabil
    setTimeout(() => buildQRCode(data), 200);

    // Nama penyusun
    if (data.penyusunNama) {
        document.getElementById("nama-penyusun").textContent = data.penyusunNama;
    }
})();
</script>

</body>
</html>



